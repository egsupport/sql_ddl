/*------------------------------------------------------------------------------
-- 개체 이름: PROC_THRESHOLD_TREND
-- 만든 날짜 : 2012-11-20 오후 5:38:49
-- 마지막으로 수정한 날짜 : 2012-11-21 오전 11:35:52
-- 상태 : VALID
------------------------------------------------------------------------------*/
CREATE OR REPLACE PROCEDURE PROC_THRESHOLD_TREND
(v_from_date IN NUMBER, v_to_date IN NUMBER)
IS
       CURSOR cSor IS
SELECT DISTINCT Q.TEST_NAME_DP,
       Q.MEASURE_DP,
       Q.TEST_NAME,
       Q.MEASURE_NAME,
       R.COLUMN_NAME,
       'INSERT INTO TG_THRESHOLD_TREND ( HOST_NAME,PORT_NO,SID,INFO,TEST_NAME_DP,MEASURE_DP,MIN_VALUE,MAX_VALUE,AVG_VALUE,MIN_ABSOLUTE,MAX_ABSOLUTE,MIN_RELATIVE,MAX_RELATIVE,POLICY_NAME,GUBUN,TEST_NAME,MEASURE_NAME )'
       ||' SELECT Z.HOST_NAME,Z.PORT_NO,Z.SID,SUBSTR (X.INFO,INSTR(X.INFO,''+'',1,1),LENGTH(X.INFO)) AS INFO,'
       ||'Z.TEST_NAME_DP,Z.MEASURE_DP,'
       ||'MIN(X.'|| R.COLUMN_NAME ||') AS MIN_VALUE,'
       ||'MAX(X.'|| R.COLUMN_NAME ||') AS MAX_VALUE,'
       ||'ROUND(AVG(X.'|| R.COLUMN_NAME ||'),2) AS AVG_VALUE,'
       ||'Z.MIN_ABSOLUTE ,Z.MAX_ABSOLUTE ,Z.MIN_RELATIVE , Z.MAX_RELATIVE ,Z.POLICY_NAME ,MAX(Z.GUBUN) AS GUBUN,'
       ||'Z.TEST_NAME,Z.MEASURE_NAME'
       ||' FROM @schema@.'
       || R.TABLE_NAME
       ||' X,(SELECT T.HOST_NAME,T.PORT_NO,T.SID,S.INFO,'
       ||'DECODE(S.MIN_ABSOLUTE,NULL,''none'',S.MIN_ABSOLUTE) AS MIN_ABSOLUTE ,'
       ||'DECODE(S.MAX_ABSOLUTE,NULL,''none'',S.MAX_ABSOLUTE) AS MAX_ABSOLUTE ,'
       ||'DECODE(S.MIN_RELATIVE,NULL,''none'',S.MIN_RELATIVE) AS MIN_RELATIVE ,'
       ||'DECODE(S.MAX_RELATIVE,NULL,''none'',S.MAX_RELATIVE) AS MAX_RELATIVE ,'
       ||'DECODE(S.POLICY_NAME,NULL,''none'',S.POLICY_NAME) AS POLICY_NAME ,'
       ||'DECODE(S.GUBUN,NULL,0,S.GUBUN) AS GUBUN,'
       ||'T.TEST_NAME,T.MEASURE_NAME,T.TEST_PERIOD,T.HOST_IP,T.COMP_NAME,T.TEST_NAME_DP,T.MEASURE_DP '
       ||'FROM (SELECT A.HOST_NAME, A.PORT_NO,A.SID,B.TEST_NAME,C.MEASURE_NAME,A.TEST_PERIOD,'
       ||' A.HOST_IP,A.COMP_NAME,B.DISP_NAME AS TEST_NAME_DP,C.DISP_NAME AS MEASURE_DP'
       ||' FROM TG_AGENTS A,TG_TEST_DISP_MAP B,TG_MEASURE_DISP_MAP C'
       ||' WHERE A.TEST_NAME = B.TEST_NAME AND A.TEST_NAME=C.TEST_NAME '
       || ' AND A.TEST_NAME='''
       || Q.TEST_NAME
       || '''AND C.MEASURE_NAME='''
       || Q.MEASURE_NAME
       || ''') T,'
       || '(SELECT S1.HOST_NAME,S1.PORT_NO,S1.SID,S1.INFO,S1.TEST_NAME,S1.MEASURE_NAME,S1.TEST_NAME_DP,'
       || 'S1.MEASURE_NAME_DP,S1.MIN_ABSOLUTE,S1.MAX_ABSOLUTE,S1.MIN_RELATIVE,S1.MAX_RELATIVE,S1.POLICY_NAME,S1.GUBUN'
       || ' FROM TG_THRESHOLD_VIEW S1,'
       || '(SELECT HOST_NAME,PORT_NO,SID,INFO,TEST_NAME,MEASURE_NAME,MAX(GUBUN) AS GUBUN'
       || ' FROM TG_THRESHOLD_VIEW  GROUP BY HOST_NAME,PORT_NO,SID,INFO,TEST_NAME,MEASURE_NAME ) S2'
       || ' WHERE S1.HOST_NAME=S2.HOST_NAME AND S1.PORT_NO=S2.PORT_NO AND S1.SID=S2.SID'
       || ' AND S1.INFO=S2.INFO AND S1.TEST_NAME=S2.TEST_NAME AND S1.MEASURE_NAME=S2.MEASURE_NAME AND S1.GUBUN=S2.GUBUN) S'
       ||' WHERE T.HOST_NAME = S.HOST_NAME (+) AND T.PORT_NO = S.PORT_NO (+) AND T.SID = S.SID (+) AND T.TEST_NAME=S.TEST_NAME (+) AND T.MEASURE_NAME=S.MEASURE_NAME(+)) Z'
       || ' WHERE Z.TEST_NAME ='''
       || Q.TEST_NAME
       || '''	AND Z.MEASURE_NAME = '''
       || Q.MEASURE_NAME
       || '''AND Z.HOST_NAME = X.TRGT_HOST AND Z.PORT_NO = X.PORT_NO'
       || ' AND DECODE (Z.GUBUN,3,Z.INFO,1) = DECODE (Z.GUBUN,3,X.INFO,1)'
       || ' AND X.MSMT_TIME BETWEEN TO_DATE('''
       || v_from_date
       || ' 00:00:00'', ''YYYY/MM/DD HH24:MI:SS'')'
       || ' AND TO_DATE('''
       || v_to_date
       || ' 23:59:59'', ''YYYY/MM/DD HH24:MI:SS'')'
       || ' GROUP BY Z.HOST_NAME,Z.PORT_NO,Z.SID,X.INFO,Z.TEST_NAME_DP,Z.MEASURE_DP,'
       || ' Z.MIN_ABSOLUTE,Z.MAX_ABSOLUTE,Z.MIN_RELATIVE,Z.MAX_RELATIVE, Z.POLICY_NAME,Z.TEST_NAME,Z.MEASURE_NAME'        AS QUERY
  FROM
       (SELECT A.HOST_NAME,
              A.PORT_NO,
              A.SID,
              B.TEST_NAME,
              C.MEASURE_NAME,
              A.TEST_PERIOD,
              A.HOST_IP,
              A.COMP_NAME,
              B.DISP_NAME AS TEST_NAME_DP,
              C.DISP_NAME AS MEASURE_DP
         FROM TG_AGENTS A,
              TG_TEST_DISP_MAP B,
              TG_MEASURE_DISP_MAP C
        WHERE A.TEST_NAME = B.TEST_NAME
              AND A.TEST_NAME=C.TEST_NAME
       ) Q,
       TG_TABLE R
 WHERE Q.TEST_NAME = R.TABLE_NAME
       AND Q.MEASURE_NAME = R.MEASURE_NAME
       AND R.FLAG ='column' ;
v_TEST_NAME_DP VARCHAR2(500);
v_MEASURE_DP   VARCHAR2(500);
v_TEST_NAME    VARCHAR2(128);
v_MEASURE_NAME VARCHAR2(128);
v_COLUMN_NAME  VARCHAR2(128);
v_QUERY        VARCHAR2(4000);
v_Commit_Flag  NUMBER;
BEGIN

    DELETE
      FROM TG_THRESHOLD_TREND;
    COMMIT;
    v_Commit_Flag :=0;
    OPEN cSor;
    LOOP
        FETCH cSor INTO v_TEST_NAME_DP,
        v_MEASURE_DP,
        v_TEST_NAME,
        v_MEASURE_NAME,
        v_COLUMN_NAME,
        v_QUERY;
        EXIT
    WHEN cSor%NOTFOUND;
        --Dbms_Output.Put_Line('sql2 : ' ||v_QUERY );
        EXECUTE IMMEDIATE v_QUERY;
        v_Commit_Flag:=v_Commit_Flag+1;
        IF mod(v_Commit_Flag,50) =0 THEN
            COMMIT;
        END IF ;
    END LOOP;
    COMMIT;
    CLOSE cSor;
END PROC_THRESHOLD_TREND;


